"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const http2 = require("http2");
const http_utils_1 = require("./http-utils");
/**
 * This is a utility for helping with HTTP/2 Push for node servers.
 */
async function push(stream, pushCtx) {
    const requestHeaders = {
        ':path': pushCtx.request.requestTarget,
        ...pushCtx.request.headers.getAll(),
    };
    let pushStream;
    try {
        pushStream = await getPushStream(stream, requestHeaders);
    }
    catch (err) {
        if (err.code === 'ERR_HTTP2_PUSH_DISABLED') {
            // HTTP/2 disabled pusing after all
            return;
        }
        throw err;
    }
    pushStream.on('error', err => {
        const isRefusedStream = pushStream.rstCode === http2.constants.NGHTTP2_REFUSED_STREAM;
        if (!isRefusedStream) {
            throw err;
        }
    });
    pushStream.respond({
        ':status': 200,
        ...pushCtx.response.headers.getAll(),
    });
    http_utils_1.sendBody(pushStream, pushCtx.response.body);
}
exports.default = push;
function getPushStream(stream, requestHeaders) {
    return new Promise((res, rej) => {
        stream.pushStream(requestHeaders, (err, pushStream) => {
            if (err) {
                rej(err);
                return;
            }
            res(pushStream);
        });
    });
}
//# sourceMappingURL=push.js.map